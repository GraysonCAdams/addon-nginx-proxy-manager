# Home Assistant Ingress Support for NPM Admin Interface
# This configuration handles the ingress path prefix rewriting

# WebSocket connection upgrade map (must be before server block)
map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

server {
    listen 81 default;
    listen [::]:81 default;

    server_name nginxproxymanager;
    root /opt/nginx-proxy-manager/frontend;
    access_log /dev/null;

    # Enable sub_filter for response body rewriting
    sub_filter_once off;
    sub_filter_types text/html text/css text/javascript application/javascript application/json;

    # Rewrite absolute paths to use ingress path prefix
    # The X-Ingress-Path header is set by Home Assistant Supervisor
    set $ingress_path "";
    if ($http_x_ingress_path) {
        set $ingress_path $http_x_ingress_path;
    }

    # API endpoint - proxy to Node.js backend
    location /api {
        return 302 $ingress_path/api/;
    }

    location /api/ {
        add_header X-Served-By $host;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Scheme $scheme;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Ingress-Path $ingress_path;
        proxy_pass http://127.0.0.1:3000/;

        proxy_read_timeout 15m;
        proxy_send_timeout 15m;

        # WebSocket support for real-time updates
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }

    # Static files and SPA routing
    location / {
        index index.html;

        # Rewrite absolute URLs in HTML/JS responses for ingress compatibility
        # These patterns handle common absolute path references in the NPM frontend
        sub_filter 'href="/' 'href="$ingress_path/';
        sub_filter "href='/" "href='$ingress_path/";
        sub_filter 'src="/' 'src="$ingress_path/';
        sub_filter "src='/" "src='$ingress_path/";
        sub_filter 'action="/' 'action="$ingress_path/';
        sub_filter '"/api/' '"$ingress_path/api/';
        sub_filter "'/api/" "'$ingress_path/api/";
        sub_filter 'url(/' 'url($ingress_path/';
        sub_filter 'url("/' 'url("$ingress_path/';
        sub_filter "url('/" "url('$ingress_path/";

        # Handle fetch/axios API calls in JavaScript
        sub_filter '"/api"' '"$ingress_path/api"';
        sub_filter "'/api'" "'$ingress_path/api'";
        sub_filter 'fetch("/' 'fetch("$ingress_path/';
        sub_filter "fetch('/" "fetch('$ingress_path/";

        # Handle redirects and navigation
        sub_filter 'window.location="/' 'window.location="$ingress_path/';
        sub_filter "window.location='/" "window.location='$ingress_path/";
        sub_filter 'location.href="/' 'location.href="$ingress_path/';
        sub_filter "location.href='/" "location.href='$ingress_path/";
        sub_filter 'history.pushState' 'history.pushState';

        if ($request_uri ~ ^/(.*)\.html$) {
            return 302 $ingress_path/$1;
        }

        try_files $uri $uri.html $uri/ /index.html;
    }
}
